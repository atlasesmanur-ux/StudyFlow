{% extends "layout.html" %}

{% block title %}Panelim - StudyFlow{% endblock %}

{% block content %}

<div class="dashboard-header">

    <div class="welcome-area">
        <h1>
            Merhaba, <span style="color: var(--secondary-fuchsia);">{{ session.username.split(' ')[0] }}</span>! 
        </h1>
        
        <div style="margin-top: 10px;">
            {% set badge_class = 'rank-bronze' %}
            {% if 'Efsanesi' in user_rank %}{% set badge_class = 'rank-legend' %}
            {% elif 'Usta' in user_rank %}{% set badge_class = 'rank-master' %}
            {% elif 'Ã‡alÄ±ÅŸkan' in user_rank %}{% set badge_class = 'rank-silver' %}
            {% endif %}
            
            <span class="rank-badge {{ badge_class }}" 
                  style="background-color: {{ rank_color }}15; color: {{ rank_color }}; border: 1px solid {{ rank_color }}; padding: 6px 12px; border-radius: 15px; font-weight: bold; display: inline-flex; align-items: center; gap: 5px;">
                {% if 'Efsanesi' in user_rank %}ğŸ†
                {% elif 'Usta' in user_rank %}ğŸ¥‡
                {% elif 'Ã‡alÄ±ÅŸkan' in user_rank %}ğŸ¥ˆ
                {% else %}ğŸ¥‰
                {% endif %}
                {{ user_rank }}
            </span>
        </div>
    </div>

   <div class="action-buttons">
        
        <a href="{{ url_for('pomodoro_page') }}" class="btn-action-card btn-pomodoro">
            <span class="btn-icon-large">â±ï¸</span> 
            <div class="btn-kanban-text">
                <span class="btn-sub-text" style="color: var(--text-muted);">Odaklan</span>
                <span class="btn-main-text">Pomodoro</span>
            </div>
        </a>

        <a href="{{ url_for('kanban_board') }}" class="btn btn-primary btn-action-card btn-kanban">
            <span class="btn-icon-large">ğŸ“…</span>
            <div class="btn-kanban-text">
                <span class="btn-sub-text">Kanban</span>
                <span class="btn-main-text">Panosu</span>
            </div>
        </a>

        <a href="{{ url_for('add_session') }}" class="btn btn-secondary btn-add-quick" title="Manuel Seans Ekle">
            +
        </a>

    </div>
</div>

<div style="margin-bottom: 30px;">
    <div class="card">
        <h3 style="font-size: 1.3em; color: white; margin-bottom: 20px;">Ders SÃ¼releri Takibi (Toplam Harcanan SÃ¼re)</h3>
        <div id="chart"></div>
    </div>
</div>

<div class="dashboard-grid" style="margin-bottom: 40px;">
    <div class="card summary-card">
        <h2>Bu Haftaki Ã‡alÄ±ÅŸman</h2>
        <div class="stat-main">
            {{ weekly_total_hours }}<span class="stat-sub">sa</span> 
            {{ weekly_remaining_minutes }}<span class="stat-sub">dk</span>
        </div>
        <div style="background-color: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden;">
            <div style="width: {{ progress_percentage }}%; background-color: var(--success-green); height: 100%;"></div>
        </div>
        <p style="font-size: 0.8em; color: var(--text-muted); margin-top: 5px;">Hedefin: {{ default_goal_hours }} saat (%{{ progress_percentage }})</p>
    </div>

    <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0;">Proje Ä°lerleme Durumu</h3>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
    </div>
    
    <div class="progress-bar-container">
        <div class="progress-bar-text">
            <span class="progress-percentage">%{{ progress_percentage }}</span> 
            
            <span class="progress-label">
                <strong style="color:var(--text-light)">{{ completed_tasks }}</strong> / {{ total_tasks }} GÃ¶rev
            </span> 
        </div>

        <div class="progress-bar-bg">
            <div class="progress-bar-fill" style="width: {{ progress_percentage }}%;"></div> 
        </div>
    </div>

    <div style="margin-top: 15px; font-size: 0.9em; color: var(--text-muted); display:flex; align-items:center; gap:8px;">
        
        {% if progress_percentage == 100 %}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            <span style="color:var(--success-green); font-weight:600;">TÃ¼m gÃ¶revler baÅŸarÄ±yla tamamlandÄ±.</span>
        
        {% elif progress_percentage >= 50 %}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--secondary-fuchsia)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            <span>SÃ¼reÃ§ %50 seviyesini geÃ§ti, devam ediliyor.</span>
        
        {% elif progress_percentage > 0 %}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            <span>Aktif gÃ¶revler Ã¼zerinde Ã§alÄ±ÅŸÄ±lÄ±yor.</span>
        
        {% else %}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
            <span>HenÃ¼z tamamlanmÄ±ÅŸ bir gÃ¶rev bulunmuyor.</span>
        {% endif %}
    </div>
</div>
</div>

{% if active_plans %}
<div style="margin-bottom: 30px;">
    <h3 style="color: var(--text-muted); margin-bottom: 15px;">HaftalÄ±k Hedeflerin</h3>
    
    {% for plan in active_plans %}
    <div class="card plan-status-card" style="margin-bottom: 15px;">
        <h4 style="font-size: 1rem; color: var(--secondary-fuchsia);">ğŸ“… Hedef #{{ loop.index }}</h4>
        
        <p style="font-size: 1.1em; margin-top: 10px; white-space: pre-line;">{{ plan.goals }}</p>
        
        <div style="margin-top: 10px; font-size: 0.85em; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.05); padding-top: 5px;">
            Plan BitiÅŸ: {{ next_monday.strftime('%d.%m.%Y') }}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<h2 style="border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px;">Son Ã‡alÄ±ÅŸmalarÄ±n</h2>
<div class="session-list">
    {% for session in sessions %}
    <div class="card session-card">
        <h2>{{ session.task_name }}</h2>
        <p><strong>Tarih:</strong> {{ session.start_time.strftime('%d.%m.%Y') }}</p>
        <p><strong>SÃ¼re:</strong> {{ session.duration_minutes }} dk</p>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
            <span style="font-size: 0.85em; color: var(--text-muted);">
                {{ session.start_time.strftime('%H:%M') }} - {{ session.end_time.strftime('%H:%M') }}
            </span>
            <a href="{{ url_for('edit_session', session_id=session.id) }}" class="btn btn-sm btn-outline" style="font-size: 0.8em; padding: 5px 10px;">DÃ¼zenle</a>
        </div>
        {% if session.notes %}
        <div class="notes">{{ session.notes }}</div>
        {% endif %}
    </div>
    {% else %}
    <p style="color: var(--text-muted);">HenÃ¼z kayÄ±tlÄ± Ã§alÄ±ÅŸma seansÄ± yok. Hemen bir tane ekle!</p>
    {% endfor %}
</div>

{% endblock content %}

{% block scripts %}
<div id="dashboard-data" 
     data-grafik='{{ grafik_datasi | tojson | safe }}'
     style="display: none;">
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    // 2. VERÄ°LERÄ° GÃœVENLÄ°CE Ã‡EK
    var dataStore = document.getElementById('dashboard-data');
    var rawData = JSON.parse(dataStore.dataset.grafik); // Veriyi buradan alÄ±yoruz

    // 3. GRAFÄ°ÄÄ° Ã‡Ä°ZDÄ°R (Senin istediÄŸin Mor SÃ¼tun GrafiÄŸi)
    if (rawData.length > 0) {
        var labels = rawData.map(item => item.kategori);
        var series = rawData.map(item => item.sÃ¼re);

        var options = {
            series: [{
                name: 'SÃ¼re',
                data: series
            }],
            chart: {
                type: 'bar', 
                height: 350,
                background: 'transparent',
                toolbar: { show: false }
            },
            // Senin Mor Renklerin
            colors: ['#7B1FA2', '#9C27B0', '#BA68C8', '#8A2BE2', '#FF00FF'],
            plotOptions: {
                bar: {
                    distributed: true, 
                    borderRadius: 4,
                    columnWidth: '45%', 
                }
            },
            dataLabels: { enabled: false },
            legend: { show: false },
            xaxis: {
                categories: labels,
                labels: {
                    style: { colors: '#B0B0C4', fontSize: '12px' }
                },
                axisBorder: { show: false },
                axisTicks: { show: false }
            },
            yaxis: {
                labels: {
                    style: { colors: '#B0B0C4' },
                    formatter: function (val) { return val + " dk"; }
                },
                grid: { borderColor: '#444' }
            },
            grid: {
                borderColor: '#444', 
                strokeDashArray: 0, 
                yaxis: { lines: { show: true } }
            },
            theme: { mode: 'dark' }
        };

        chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();
    } else {
        document.querySelector("#chart").innerHTML = "<p style='text-align:center; padding:20px; color:#888;'>HenÃ¼z veri yok.</p>";
    }
</script>
{% endblock scripts %}