{% extends "layout.html" %}

{% block title %}Kanban Panosu - StudyFlow{% endblock %}

{% block content %}

<div id="new-task-modal" class="task-modal-overlay" style="display: none;">
    <div class="task-modal-content card"> 
        <h3>Yeni GÃ¶rev OluÅŸtur</h3>
        <input type="text" id="task-title-input" class="form-control" placeholder="BaÅŸlÄ±k girin..." maxlength="100">
        <br>
        <textarea id="task-desc-input" class="form-control" placeholder="AÃ§Ä±klama..." rows="3"></textarea>
        <br>
        <div class="modal-actions">
            <button id="save-task-btn" class="btn btn-primary">Ekle</button>
            <button id="cancel-task-btn" class="btn btn-secondary">Ä°ptal</button>
        </div>
    </div>
</div>

<div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px;">
    <a href="{{ url_for('completed_tasks') }}" class="btn btn-secondary" style="display: flex; align-items: center; gap: 8px;">
        <span>ðŸ“‹</span> TamamlananlarÄ± GÃ¶r (Son 14 GÃ¼n)
    </a>
</div>

<div class="kanban-container">
<div class="kanban-container">
    {% for status, title in [('TODO','YapÄ±lacaklar'), ('IN_PROGRESS','SÃ¼reÃ§te'), ('DONE','TamamlandÄ±')] %}
    <div class="kanban-column">
        <div class="column-header">
            <h3>{{ title }}</h3>
            {% if status == 'TODO' %}
               <button class="add-task-btn btn btn-primary" style="width: 100%; margin-top: 10px;">+ Ekle</button>
            {% endif %}
        </div>

        <div class="kanban-cards" data-status="{{ status }}">
            {% for task in tasks %}
                {% if task.status == status %}
                <div class="task-card" draggable="true" data-task-id="{{ task.id }}">
                    <h5 class="card-title">{{ task.title }}</h5>
                    <p class="card-text text-muted">{{ task.description }}</p>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

{% endblock content %}

{% block scripts %}
<script>
// Global deÄŸiÅŸken
let draggedItem = null;

// --- SÃœRÃœKLEME EVENTLERÄ° ---

function handleDragStart(e) {
    draggedItem = this;
    e.dataTransfer.effectAllowed = 'move';
    // SÃ¼rÃ¼klenen verinin ID'sini taÅŸÄ±
    e.dataTransfer.setData("text/plain", this.dataset.taskId);
    
    // GÃ¶rsel olarak sÃ¼rÃ¼klendiÄŸini belli et (Hafif gecikme ile)
    setTimeout(() => {
        this.classList.add("dragging");
    }, 0);
}

function handleDragEnd(e) {
    this.classList.remove("dragging");
    draggedItem = null;
    // TÃ¼m sÃ¼tunlardaki vurguyu temizle
    document.querySelectorAll('.kanban-cards').forEach(col => col.classList.remove('drag-over'));
}

function handleDragOver(e) {
    e.preventDefault(); // BÄ±rakmaya izin ver
    this.classList.add('drag-over');
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    this.classList.remove('drag-over');

    if (!draggedItem) return;

    // 1. GÃ¶rsel olarak kartÄ± yeni yerine taÅŸÄ± (JavaScript ile anÄ±nda tepki)
    this.appendChild(draggedItem);

    // 2. Verileri topla
    const taskId = draggedItem.dataset.taskId;
    const newStatus = this.dataset.status; // 'TODO', 'DONE' vb.

    // 3. VeritabanÄ±na kaydet (Backend ile konuÅŸ)
    updateTaskStatus(taskId, newStatus);
}

// --- API FONKSÄ°YONLARI ---

function updateTaskStatus(id, status) {
    fetch('/api/task/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ task_id: id, status: status })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) console.log("KayÄ±t baÅŸarÄ±lÄ±:", status);
        else alert("Hata: " + data.message);
    })
    .catch(err => console.error("BaÄŸlantÄ± hatasÄ±:", err));
}

function saveNewTask(title, description) {
    fetch("/api/tasks/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, description })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // SayfayÄ± yenilemeye gerek yok, manuel olarak DOM'a ekleyelim
            location.reload(); 
        } else {
            alert("Hata: " + data.message);
        }
    });
}

// --- SAYFA YÃœKLENDÄ°ÄžÄ°NDE ---

document.addEventListener("DOMContentLoaded", () => {
    // SÃ¼tunlarÄ± (Drop Zones) ayarla
    const columns = document.querySelectorAll(".kanban-cards");
    columns.forEach(col => {
        col.addEventListener("dragover", handleDragOver);
        col.addEventListener("dragleave", handleDragLeave);
        col.addEventListener("drop", handleDrop);
    });

    // KartlarÄ± (Draggables) ayarla
    const cards = document.querySelectorAll(".task-card");
    cards.forEach(card => {
        card.addEventListener("dragstart", handleDragStart);
        card.addEventListener("dragend", handleDragEnd);
    });

    // Modal Ä°ÅŸlemleri
    const modal = document.getElementById("new-task-modal");
    const addBtn = document.querySelector(".add-task-btn");
    const saveBtn = document.getElementById("save-task-btn");
    const cancelBtn = document.getElementById("cancel-task-btn");
    const titleInput = document.getElementById("task-title-input");
    const descInput = document.getElementById("task-desc-input");

    if(addBtn) {
        addBtn.addEventListener("click", () => {
            modal.style.display = "flex"; 
            titleInput.value=""; 
            descInput.value=""; 
            titleInput.focus();
        });
    }

    if(cancelBtn) cancelBtn.addEventListener("click", () => modal.style.display = "none");

    if(saveBtn) {
        saveBtn.addEventListener("click", () => {
            const title = titleInput.value.trim();
            const desc = descInput.value.trim();
            if(!title) return alert("LÃ¼tfen baÅŸlÄ±k girin");
            saveNewTask(title, desc);
            modal.style.display = "none";
        });
    }
});
</script>
{% endblock scripts %}